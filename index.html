<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My Personal Site</title>
<meta name="theme-color" content="#0b0b0b" />
<style>
  :root{
    --bg:#0b0b0e;
    --panel:#0f1620;
    --muted:#9aa6b2;
    --accent1:#00f0ff;
    --accent2:#0066ff;
    --glass: rgba(255,255,255,0.02);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#08080a);color:#eef2f5;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
  .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:28px;box-sizing:border-box;}
  .card{
    width:100%;max-width:920px;padding:30px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 40px rgba(2,6,23,0.6);backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,0.03);
  }
  .header{display:flex;align-items:center;gap:18px;margin-bottom:18px;}
  .logo{
    width:68px;height:68px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#031018;font-size:18px;box-shadow:0 6px 18px rgba(0,150,255,0.12);
  }
  h1{font-size:1.6rem;margin:0}
  p.lead{margin:6px 0 18px;color:var(--muted);font-size:0.98rem}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  button.primary{
    background:linear-gradient(90deg,var(--accent1),var(--accent2));
    color:#071018;padding:12px 22px;border-radius:10px;border:0;font-weight:700;cursor:pointer;font-size:1rem;box-shadow:0 8px 30px rgba(0,128,255,0.12);
  }
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px 16px;border-radius:10px;color:var(--muted);cursor:pointer;}
  .muted{color:var(--muted);font-size:0.9rem;margin-top:14px}
  footer{margin-top:18px;color:#6d7a85;font-size:0.85rem}
  .unlockBox{margin-top:14px;padding:12px;border-radius:10px;background:var(--glass);display:flex;gap:10px;align-items:center;border:1px solid rgba(255,255,255,0.02);}
  .unlockBtn{padding:8px 12px;border-radius:8px;border:0;background:#fffb;color:#021;font-weight:700;cursor:pointer}
  @media (max-width:640px){ .card{padding:18px} .header{gap:12px} .logo{width:56px;height:56px} h1{font-size:1.2rem} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-labelledby="main-title">
      <div class="header">
        <div class="logo">ME</div>
        <div>
          <h1 id="main-title">Welcome</h1>
          <p class="lead">Open a full-page view of the site. The tab favicon will animate smoothly (exact GIF timing).</p>
        </div>
      </div>

      <div class="controls" role="region" aria-label="controls">
        <button id="openBtn" class="primary" title="Open the site in a new tab">Open Site</button>
        <button id="openNewWindow" class="ghost" title="Open in a new window (separate)">&nbsp;Open Window&nbsp;</button>

        <div style="flex:1"></div>

        <div style="text-align:right">
          <div style="color:var(--muted);font-size:0.88rem">Favicon: original GIF timing (64 frames, 90ms each)</div>
        </div>
      </div>

      <div class="unlockBox" style="margin-top:18px">
        <div style="flex:1;color:var(--muted)">To intentionally close without the warning: hold <strong>Ctrl + Shift</strong> and click <em>Allow Close</em>.</div>
        <button id="allowClose" class="unlockBtn" aria-label="Allow close (requires Ctrl+Shift)">Allow Close</button>
      </div>

      <div class="muted" id="heuristicLog" aria-live="polite" style="margin-top:12px">
        Close-detection: waiting...
      </div>

      <footer>My Personal Project • static (works on InfinityFree)</footer>
    </div>
  </div>

<script>
const TOTAL_FRAMES = 64;
const FRAME_DELAY = 90;

// GitHub URLs
function generateURLs(base){
  const arr=[];
  for(let i=0;i<TOTAL_FRAMES;i++){
    const num=String(i).padStart(3,'0');
    arr.push(`${base}/frame_${num}.png`);
  }
  return arr;
}
const URL_16='https://raw.githubusercontent.com/stetson609-wq/loading/main/16x16';
const URL_32='https://raw.githubusercontent.com/stetson609-wq/loading/main/32x32';

const frames16=generateURLs(URL_16);
const frames32=generateURLs(URL_32);

/* USER ACTIVITY TRACKING */
let lastUserInteraction=0, lastBlurTs=0, lastVisibilityChange=0, lastFocusTs=0;
function markUserActivity(){ lastUserInteraction=Date.now(); }
['mousemove','mousedown','keydown','touchstart','wheel'].forEach(ev=>window.addEventListener(ev, markUserActivity, {passive:true}));
window.addEventListener('visibilitychange', ()=>{ lastVisibilityChange=Date.now(); });
window.addEventListener('blur', ()=>{ lastBlurTs=Date.now(); });
window.addEventListener('focus', ()=>{ lastFocusTs=Date.now(); });

/* UNLOCK FLAG */
let allowCloseFlag=false;
document.getElementById('allowClose').addEventListener('click', ev=>{
  if(!(ev.ctrlKey && ev.shiftKey)){ ev.target.textContent='Hold Ctrl+Shift'; setTimeout(()=>{ev.target.textContent='Allow Close';},1200); return; }
  allowCloseFlag=true;
  heuristicLog.textContent='Close allowed by user. You can now close the tab/window.';
  window.removeEventListener('beforeunload', beforeUnloadHandler, {capture:true});
});

function guessCloseOrigin(){
  const now=Date.now();
  const sinceUser=now-lastUserInteraction;
  const sinceBlur=lastBlurTs? (now-lastBlurTs): Infinity;
  const sinceVis=lastVisibilityChange? (now-lastVisibilityChange): Infinity;
  if(sinceUser<=2000) return {label:'User-initiated (recent interaction detected)', confidence:'high'};
  if(sinceVis<=1500 || sinceBlur<=1500) return {label:'Possibly external/automated (visibility or blur occurred right before)', confidence:'medium'};
  return {label:'Unknown - no recent user interaction (could be automated/remote)', confidence:'low'};
}

function beforeUnloadHandler(e){
  if(allowCloseFlag) return;
  const guess=guessCloseOrigin();
  console.info('[close-heuristic]', guess);
  heuristicLog.textContent=`Close-detection: ${guess.label} — confidence: ${guess.confidence}. To close intentionally hold Ctrl+Shift and click "Allow Close".`;
  const msg=`This tab is being closed (${guess.label}). If you did not intend to close it, please cancel.`;
  e.preventDefault();
  e.returnValue=msg;
  return msg;
}
window.addEventListener('beforeunload', beforeUnloadHandler, {capture:true});

/* OPEN POPUP / ABOUT:BLANK WITH ANIMATED FAVICON */
function openAnimatedPopup(asWindow=false){
  const win=window.open('about:blank','_blank');
  if(!win){ alert('Popup blocked. Allow popups.'); return; }
  const frames=(window.devicePixelRatio>1)?frames32:frames16;
  frames.forEach(src=>{ const img=new Image(); img.src=src; });

  win.document.write(`
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Loading...</title>
<meta name="theme-color" content="#0b0b0b"/>
<link rel="icon" href="">
<style>
  html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;background:#0b0b0b;color:#fff}
  iframe{width:100vw;height:100vh;border:0;display:block}
</style>
</head>
<body>
<iframe src="https://nullxiety.com" allowfullscreen sandbox="allow-scripts allow-same-origin allow-forms allow-popups"></iframe>
<script>
const frames=${JSON.stringify(frames)};
const FRAME_DELAY=${FRAME_DELAY};
const images=frames.map(src=>{ const i=new Image(); i.src=src; return i; });

const canvas=document.createElement('canvas');
canvas.width=canvas.height=32;
const ctx=canvas.getContext('2d');

const link=document.querySelector('link[rel="icon"]') || document.createElement('link');
link.rel='icon';
document.head.appendChild(link);

let idx=0;
function animate(){
  const img=images[idx];
  if(img.complete){ ctx.clearRect(0,0,32,32); ctx.drawImage(img,0,0,32,32); setTimeout(()=>{ link.href=canvas.toDataURL('image/png'); },1); }
  idx=(idx+1)%images.length;
  setTimeout(animate, FRAME_DELAY);
}

const start=setInterval(()=>{
  if(images[0].complete){ clearInterval(start); animate(); }
},50);

window.addEventListener('beforeunload', e=>{
  const msg='Are you sure you want to leave? To intentionally close, click "Allow Close" in parent page.';
  e.preventDefault(); e.returnValue=msg; return msg;
});
</script>
</body>
</html>
  `);
  win.document.close();
  return win;
}

let popupWindow=null;
document.getElementById('openBtn').addEventListener('click', ()=>{ popupWindow=openAnimatedPopup(false); });
document.getElementById('openNewWindow').addEventListener('click', ()=>{ popupWindow=openAnimatedPopup(true); });
</script>
</body>
</html>
